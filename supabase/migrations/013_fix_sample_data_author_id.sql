-- 修复示例数据中的author_id问题
-- 这个迁移将清理并重新插入示例数据，使其与自定义认证系统兼容

-- 1. 删除现有的示例数据（如果存在）
DELETE FROM prompts WHERE is_featured = true AND author_id IS NULL;

-- 2. 创建一个临时的系统用户用于示例数据
-- 首先检查是否已存在系统用户
DO $$
DECLARE
    system_user_id UUID;
BEGIN
    -- 尝试获取现有的系统用户
    SELECT id INTO system_user_id 
    FROM custom_users 
    WHERE username = 'system_admin' 
    LIMIT 1;
    
    -- 如果不存在，创建一个系统用户
    IF system_user_id IS NULL THEN
        INSERT INTO custom_users (
            phone, 
            password_hash, 
            username, 
            full_name, 
            is_active
        ) VALUES (
            '10000000000',
            '$2b$12$dummy.hash.for.system.user.only',
            'system_admin',
            '系统管理员',
            true
        ) RETURNING id INTO system_user_id;
        
        -- 系统用户的profile会通过触发器自动创建
    END IF;
    
    -- 现在插入示例数据，使用系统用户的ID
    INSERT INTO prompts (title, description, content, category, is_featured, author_id) VALUES
    ('电商产品描述生成器', '为电商产品生成吸引人的描述文案，提升转化率', '请为以下产品生成一个吸引人的电商描述：

产品名称：{产品名称}
产品特点：{产品特点}
目标客户：{目标客户群体}
价格区间：{价格区间}

要求：
1. 突出产品核心优势和独特卖点
2. 使用情感化和感官化的语言
3. 包含明确的购买理由和紧迫感
4. 针对目标客户群体的痛点和需求
5. 字数控制在150-300字之间
6. 包含适当的关键词以提升搜索排名

输出格式：
- 产品标题（吸引眼球）
- 核心卖点（3-5个要点）
- 详细描述（包含使用场景）
- 购买理由（为什么选择我们）
- 行动召唤（引导购买）

请确保描述既专业又有说服力。', 'ecommerce', true, system_user_id),

    ('在线课程大纲设计', '系统化的课程设计模板，适用于各类在线教育内容', '请为以下主题设计一个完整的在线课程大纲：

课程主题：{课程主题}
目标学员：{学员水平和背景}
课程时长：{预期总时长}
学习目标：{期望达成的具体目标}

请包含以下内容：

1. 课程概述
   - 课程简介和价值主张
   - 学习目标和预期成果
   - 适合人群和前置要求

2. 课程结构设计
   - 模块划分（建议5-8个主要模块）
   - 每个模块的学习目标
   - 模块间的逻辑关系和递进性

3. 详细章节安排
   - 每章节的具体内容要点
   - 预估学习时间
   - 重点和难点标识

4. 实践练习设计
   - 课后作业和项目
   - 实操练习和案例分析
   - 阶段性测试和评估

5. 学习资源配置
   - 必读材料和参考资料
   - 辅助工具和软件
   - 扩展学习建议

6. 评估和认证
   - 学习进度跟踪方式
   - 成绩评定标准
   - 证书获取条件

请确保课程设计科学合理，循序渐进。', 'education', true, system_user_id),

    ('投资分析报告模板', '专业的投资分析框架，帮助做出理性投资决策', '请分析以下投资标的并生成专业报告：

投资标的：{股票/基金/项目名称}
分析维度：{基本面/技术面/市场环境}
投资期限：{短期/中期/长期}
风险偏好：{保守/平衡/激进}

分析框架：

1. 投资标的基本信息
   - 基本概况和业务模式
   - 行业地位和竞争优势
   - 财务状况概览

2. 基本面分析
   - 财务指标分析（盈利能力、偿债能力、运营效率）
   - 行业发展趋势和市场前景
   - 公司治理和管理团队评估
   - 核心竞争力和护城河分析

3. 技术面分析
   - 价格走势和技术指标
   - 支撑位和阻力位分析
   - 成交量和资金流向
   - 技术形态和趋势判断

4. 风险评估
   - 系统性风险（市场风险、政策风险）
   - 非系统性风险（经营风险、财务风险）
   - 流动性风险和信用风险
   - 风险控制措施建议

5. 收益预期
   - 目标价位和预期收益率
   - 不同情景下的收益测算
   - 投资回报周期预估

6. 投资建议
   - 买入/持有/卖出建议
   - 仓位配置建议
   - 止盈止损策略
   - 定期复评机制

请提供客观、专业的分析意见。', 'finance', true, system_user_id),

    ('AI绘画提示词优化器', '专业的AI绘画提示词优化工具，提升图像生成质量', '请优化以下AI绘画提示词：

原始需求：{用户的绘画需求描述}
绘画风格：{写实/动漫/油画/水彩/概念艺术等}
画面主体：{人物/风景/物品/抽象等}
情感氛围：{期望传达的情感或氛围}

优化要求：

1. 主体描述优化
   - 精确描述主要元素
   - 添加具体的视觉细节
   - 明确主体的姿态、表情、动作

2. 风格和技法指导
   - 指定艺术风格和流派
   - 添加绘画技法描述
   - 参考知名艺术家风格

3. 构图和视角
   - 明确画面构图方式
   - 指定拍摄角度和视角
   - 景深和焦点设置

4. 光影和色彩
   - 描述光照条件和方向
   - 指定色彩搭配和色调
   - 氛围和质感要求

5. 画质和技术参数
   - 分辨率和画质要求
   - 渲染质量设置
   - 特殊效果需求

6. 负面提示词
   - 需要避免的元素
   - 质量问题预防
   - 风格冲突避免

输出格式：
- 正面提示词（英文，详细描述）
- 负面提示词（英文，避免问题）
- 参数建议（采样方法、步数、CFG等）
- 风格参考（相似作品或艺术家）

请确保提示词准确、专业且易于AI理解。', 'image', true, system_user_id),

    ('短视频脚本创作助手', '专业的短视频脚本模板，提升视频传播效果', '请为以下内容创作短视频脚本：

视频主题：{主题内容}
视频时长：{30秒/60秒/3分钟}
目标平台：{抖音/小红书/B站/微信视频号}
目标观众：{年龄段、兴趣爱好、职业等}
视频目标：{涨粉/带货/品牌宣传/知识分享}

脚本结构：

1. 开头设计（前3-5秒）
   - 吸引注意力的钩子
   - 快速建立观看动机
   - 预告核心价值点

2. 主体内容展开
   - 核心信息传递
   - 逻辑清晰的内容结构
   - 保持观众注意力的技巧

3. 互动引导设计
   - 评论区互动话题
   - 点赞和分享引导
   - 关注账号的理由

4. 结尾行动召唤
   - 明确的下一步指引
   - 相关内容推荐
   - 持续关注的价值

5. 视觉和音效建议
   - 画面切换节奏
   - 背景音乐选择
   - 字幕和特效使用

6. 平台优化要点
   - 标题和封面建议
   - 标签和话题选择
   - 发布时间建议

输出格式：
- 完整脚本（分镜头描述）
- 文案内容（配音稿）
- 拍摄要点（镜头和道具）
- 后期制作建议（剪辑和特效）

请确保脚本有趣、实用且符合平台特色。', 'video', true, system_user_id);
    
END $$;

-- 3. 添加注释
COMMENT ON TABLE custom_users IS '自定义用户表，包含系统管理员用于示例数据';